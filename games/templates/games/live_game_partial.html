{# games/templates/games/live_game_partial.html #}
{# Everything inside #live-area: scoreboard, defense, bases, matchup #}

<div class="row">
  <!-- LEFT 2/3: Scoreboard + (Defense & Bases) -->
  <div class="col-md-8">
    {# Scoreboard #}
    <table class="table table-sm">
      <thead>
        <tr>
          <th></th>
          {% for inning in innings %}
            <th>{{ inning }}</th>
          {% endfor %}
          <th>R</th><th>H</th><th>E</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <th>{{ session.game.away_team }}</th>
          {% for run in away_scores %}<td>{{ run }}</td>{% endfor %}
          <td>{{ away_totals.runs }}</td>
          <td>{{ away_totals.hits }}</td>
          <td>{{ away_totals.errors }}</td>
        </tr>
        <tr>
          <th>{{ session.game.home_team }}</th>
          {% for run in home_scores %}<td>{{ run }}</td>{% endfor %}
          <td>{{ home_totals.runs }}</td>
          <td>{{ home_totals.hits }}</td>
          <td>{{ home_totals.errors }}</td>
        </tr>
      </tbody>
    </table>

    {# Defense & Baserunners below, still in left 2/3 #}
    <div class="row mt-3">
      <!-- Defense (left half of 2/3) -->
      <div class="col-md-6">
        <h6>Defense</h6>
        <form
          id="defense-form"
          method="post"
          hx-post="{% url 'games:live_game' session.id %}"
          hx-trigger="submit"
          hx-target="#live-area"
          hx-swap="innerHTML"
        >
          {% csrf_token %}
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>Pos</th><th>Player</th><th>Rating</th>
                  <th class="text-center">A</th>
                  <th class="text-center">PO</th>
                  <th class="text-center">E</th>
                </tr>
              </thead>
              <tbody>
                {% for spot in defense_spots %}
                <tr>
                  <td>{{ spot.position }}</td>
                  <td>{{ spot.player.last_name }}</td>
                  <td>{{ spot.rating }}</td>
                  <td class="text-center">
                    <input class="form-check-input" type="radio"
                           name="def_{{ spot.index }}" value="A">
                  </td>
                  <td class="text-center">
                    <input class="form-check-input" type="radio"
                           name="def_{{ spot.index }}" value="PO">
                  </td>
                  <td class="text-center">
                    <input class="form-check-input" type="radio"
                           name="def_{{ spot.index }}" value="E">
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <button type="submit" class="btn btn-sm btn-primary">
            Save Defense
          </button>
        </form>
      </div>

      <!-- Baserunners (right half of 2/3) -->
      <div class="col-md-6">
        <h6>Bases</h6>
        <form
          id="bases-form"
          method="post"
          hx-post="{% url 'games:live_game' session.id %}"
          hx-trigger="submit"
          hx-target="#live-area"
          hx-swap="innerHTML"
          hx-include="#defense-form"
        >
          {% csrf_token %}
          {% for base in bases %}
            <div class="mb-2">
              <strong>{{ base.name }}:</strong>
              {% if base.runner %}
                {{ base.runner.last_name }}
                {% for code,label in base_actions %}
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio"
                           name="base_{{ base.index }}" value="{{ code }}"
                           id="base_{{ base.index }}_{{ code }}">
                    <label class="form-check-label"
                           for="base_{{ base.index }}_{{ code }}">
                      {{ label }}
                    </label>
                  </div>
                {% endfor %}
              {% else %}
                <em>Empty</em>
              {% endif %}
            </div>
          {% endfor %}
          <button type="submit" class="btn btn-sm btn-primary">
            Apply Bases & Defense
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- RIGHT 1/3: Matchup cards & result buttons -->
  <div class="col-md-4">
    {# Game status #}
    <div class="mb-2">
      <strong>
        {{ session.is_top|yesno:"Top,Bottom" }} of {{ session.inning }}
        &mdash; {{ session.outs }} {{ session.outs|pluralize:"out,outs" }}
      </strong>
    </div>

    {# Away/Home cards #}
    <div class="card mb-2">
      <div class="card-header">{{ session.game.away_team }}</div>
      <div class="card-body">
        <h6 class="card-title">{{ away_player }}</h6>
        <p class="card-text">Rating: {{ away_rating }}</p>
      </div>
    </div>
    <div class="card mb-2">
      <div class="card-header">{{ session.game.home_team }}</div>
      <div class="card-body">
        <h6 class="card-title">{{ home_player }}</h6>
        <p class="card-text">Rating: {{ home_rating }}</p>
      </div>
    </div>

    {# Play‚Äêresult form #}
    <form
      id="play-form"
      method="post"
      hx-post="{% url 'games:live_game' session.id %}"
      hx-trigger="submit"
      hx-target="#live-area"
      hx-swap="innerHTML"
      hx-include="#defense-form, #bases-form"
    >
      {% csrf_token %}
      <div class="btn-group flex-wrap">
        {% for code,label in play_choices %}
          <button
            type="submit"
            name="result"
            value="{{ code }}"
            class="btn btn-outline-primary m-1 flex-fill"
          >
            {{ label }}
          </button>
        {% endfor %}
        <button
          type="submit"
          name="result"
          value="FC"
          class="btn btn-outline-secondary m-1 flex-fill"
        >
          FC
        </button>
        <button
          type="submit"
          name="result"
          value="E"
          class="btn btn-outline-danger m-1 flex-fill"
        >
          Error
        </button>
      </div>
    </form>

    {# Substitute & Restart #}
    <a href="{% url 'games:substitute' session.id %}"
       class="btn btn-secondary mt-2 w-100">Substitute</a>
    <a href="{% url 'games:setup_game' %}"
       class="btn btn-outline-danger mt-1 w-100">Start New Game</a>
  </div>
</div>
